name: Snowflake Query in Demo Env

on:
  workflow_dispatch:

jobs:
  run-snowflake-query:
    runs-on: ubuntu-latest
    environment: Demo

    steps:
    - name: Install Snowflake CLI using pipx
      run: |
        pipx install snowflake-cli
        echo "/opt/pipx_bin" >> $GITHUB_PATH

    - name: Create Snowflake config at ~/.snowflake/config.toml
      run: |
        mkdir -p ~/.snowflake
        cat > ~/.snowflake/config.toml <<EOF
        [connections.demo]
        account = "${{ secrets.SNOWFLAKE_ACCOUNT }}"
        username = "${{ secrets.SNOWFLAKE_USER }}"
        password = "${{ secrets.SNOWFLAKE_PASSWORD }}"
        role = "${{ secrets.SNOWFLAKE_ROLE }}"
        warehouse = "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
        database = "${{ secrets.SNOWFLAKE_DATABASE }}"
        schema = "${{ secrets.SNOWFLAKE_SCHEMA }}"
        EOF
        chmod 600 ~/.snowflake/config.toml

    - name: Debug config file
      run: |
        echo "File content:"
        cat ~/.snowflake/config.toml
        echo "Checking sf CLI version and path:"
        which snow
        snow --version

    - name: Run SQL using Snowflake CLI
      run: |
        snow sql --connection demo --query "CREATE OR REPLACE TABLE demo_employees (
          id INT,
          name STRING,
          role STRING,
          start_date DATE,
          salary NUMBER(10,2)
        );"
